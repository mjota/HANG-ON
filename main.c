/*****************************************************

        Plug n Play Library for Nokia 3310 LCD

        Author:  Ajay Bhargav
		Email :  contact@rickeyworld.info
		WWW   :  www.8051projects.net

		File  :  Nokia3310.C
		Info  :  Test Program to check working of
		         Library

*****************************************************/

#include "main.h"


/* Some Custom Graphics data
   Run it and see it :)      */
   
unsigned int poscar;
int c,t,l,d=0; 
unsigned int posxobs,aposxobs,posyobs,easyobs;
unsigned int posxlife,posylife;
unsigned int flagobs, flagcar, flagtime, flagdie, flaglife = 0;
unsigned int segs,mins = 0;	
int sel = 0;
   
unsigned char code sega[504] = {
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x80,0xC0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0x00,0x00,0x00,0x00,0x80,
	0xC0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0x00,0x00,0x00,0x00,0x80,0xC0,
	0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x80,0xC0,0xE0,0xE0,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x7C,0xE7,0x81,0x00,0x3C,0x6E,0x6E,0xEE,0xCE,0xCE,0x8E,0x0E,0x00,
	0x00,0x00,0xFF,0x03,0x01,0x78,0x7C,0x7E,0x7E,0x7E,0x7E,0x7E,0x0E,0x0E,0x00,0x00,
	0x00,0xFF,0x03,0x01,0xF8,0x0C,0x0E,0x7E,0x7E,0x7E,0x7E,0x7E,0x7E,0xFE,0x00,0x00,
	0x00,0x00,0x00,0x80,0xF0,0x1E,0x03,0xC0,0x78,0x70,0x81,0x07,0x38,0xE0,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xF0,0xF1,0xF3,0xF3,0xF7,0xF7,0xF6,0xBE,0x98,
	0xC0,0xE3,0x3E,0x00,0x00,0x00,0x7F,0xE0,0xC0,0x9F,0xB7,0xF7,0xF7,0xF7,0xF7,0xF7,
	0xF0,0xF0,0x00,0x00,0x00,0x7F,0xE0,0xC0,0x9F,0xB0,0xF0,0xF7,0xF7,0xF7,0xFF,0x80,
	0x80,0xFF,0x00,0x00,0x00,0xE0,0x3C,0x07,0xC0,0x70,0x7E,0x70,0x70,0x70,0x73,0x7C,
	0x60,0x01,0x0F,0x78,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x03,0x03,0x03,0x03,
	0x03,0x03,0x03,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x03,0x03,0x03,
	0x03,0x03,0x03,0x03,0x03,0x03,0x00,0x00,0x00,0x00,0x00,0x01,0x03,0x03,0x03,0x03,
	0x03,0x03,0x03,0x03,0x03,0x03,0x02,0x02,0x03,0x01,0x00,0x02,0x01,0x00,0x00,0x03,
	0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x02,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};

unsigned char code logo[504] = {
	0xFF,0x03,0x03,0xFB,0xFB,0x03,0x03,0x03,0x03,0x03,0xFB,0xFB,0x03,0x03,0x03,0x03,
	0x03,0x03,0xC3,0x7B,0x7B,0xE3,0x03,0x03,0x03,0x03,0x03,0x03,0xFB,0xFB,0xF3,0xC3,
	0x03,0x03,0x03,0xFB,0xFB,0x03,0x03,0x03,0x03,0xE3,0xF3,0x33,0x1B,0x1B,0x1B,0x1B,
	0x73,0x23,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0xE3,0xF3,0x13,0x1B,0x1B,
	0x1B,0x13,0xF3,0xE3,0x03,0x03,0x03,0x03,0xFB,0xFB,0xF3,0xC3,0x03,0x03,0x03,0xFB,
	0xFB,0x03,0x03,0xFF,0xFF,0x00,0x00,0x7F,0x7F,0x03,0x03,0x03,0x03,0x03,0x7F,0x7F,
	0x00,0x00,0x00,0x60,0x78,0x1F,0x1B,0x18,0x18,0x19,0x1F,0x7C,0x60,0x00,0x00,0x00,
	0x7F,0x7F,0x01,0x01,0x03,0x0E,0x3C,0x7F,0x7F,0x00,0x00,0x00,0x03,0x1F,0x3F,0x70,
	0x60,0x60,0x63,0x63,0x33,0x3F,0x00,0x00,0x00,0x0E,0x0E,0x0E,0x00,0x00,0x03,0x1F,
	0x3F,0x60,0x60,0x60,0x60,0x60,0x3F,0x1F,0x03,0x00,0x00,0x00,0x7F,0x7F,0x01,0x01,
	0x03,0x0E,0x3C,0x7F,0x7F,0x00,0x00,0xFF,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,
	0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0xC3,
	0xC3,0xC3,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,
	0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,
	0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,
	0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x80,0x82,0xC6,0xCF,0xDF,0xCF,0xC6,0x82,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0xC0,0x00,
	0x70,0x70,0x70,0x70,0x70,0x70,0x70,0x70,0x70,0x70,0x70,0x70,0x70,0x70,0xFC,0xF8,
	0x70,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x02,0x07,0x0F,0x0F,0x1F,0x1F,0x1F,0x1F,0x1F,0x0F,0x0F,0x07,0x02,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,
	0x07,0x0F,0x1F,0x07,0x07,0x07,0x07,0x07,0x07,0x07,0x07,0x07,0x07,0x07,0x07,0x07,
	0x07,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};

unsigned char code marizq[240] = {
	0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,
	0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0xF3,0x13,0x13,0x13,0x13,0x13,0x13,0xD3,
	0xD3,0xD3,0x13,0x13,0x13,0x13,0x13,0x13,0xF3,0x03,0x03,0x03,0x03,0x03,0x03,0x03,
	0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,
	0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,
	0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,
	0x80,0x82,0xC6,0xCF,0xDF,0xCF,0xC6,0x82,0x80,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0xC0,0x00,
	0x70,0x70,0x70,0x70,0x70,0x70,0x70,0x70,0x70,0x70,0x70,0x70,0x70,0x70,0xFC,0xF8,
	0x70,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x7F,0x40,0x42,0x47,0x4F,0x4F,0x5F,0x5F,0x5F,0x5F,0x5F,0x4F,0x4F,0x47,0x42,0x40,
	0x7F,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,
	0x07,0x0F,0x1F,0x07,0x07,0x07,0x07,0x07,0x07,0x07,0x07,0x07,0x07,0x07,0x07,0x07,
	0x07,0x00,0x01,0x00,0x00,0x00,0x00,0x00
};

unsigned char code marder[240] = {
	0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,
	0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0xC3,
	0xC3,0xC3,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,
	0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,
	0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,
	0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x80,0x82,0xC6,0xCF,0xDF,0xCF,0xC6,0x82,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x01,0x01,0x01,0x81,0xC1,0x01,
	0x71,0x71,0x71,0x71,0x71,0x71,0x71,0x71,0x71,0x71,0x71,0x71,0x71,0x71,0xFD,0xF9,
	0x71,0x21,0x01,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x02,0x07,0x0F,0x0F,0x1F,0x1F,0x1F,0x1F,0x1F,0x0F,0x0F,0x07,0x02,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x7F,0x40,0x42,
	0x47,0x4F,0x5F,0x47,0x47,0x47,0x47,0x47,0x47,0x47,0x47,0x47,0x47,0x47,0x47,0x47,
	0x47,0x40,0x41,0x40,0x40,0x40,0x40,0x7F
};

unsigned char code heart[8] = {
	0x0C,0x1E,0x3E,0x7C,0x3E,0x1E,0x0C,0x00,
};

void inittimer(){
	TMOD &= 0xF0;		/*Timer 0 en modo 2: Contador autorecargable */
	TMOD |= 0x09;		/* GATE0=1; C/T0#=0; T0M1=1; T0M0=0; */
	
	TH0 = 0x00;	        /* Valor inicial de autorecarga */
	TL0 = 0x00;			// Valor inicial del contador
	ET0=1;				/* Configura interrupción de timer 0 */
	EA=1;               /* Habilita interrupciones */
	TR0=1;	
}
   
void it_timer0(void) interrupt 1{
	
	if (sel==0){
		if(BUT_ES==0){
			flagcar=1;
		}
		if(BUT_DR==0){
			flagcar=2;
		}	
	}else{
		if(AC_ES==0){
			flagcar=1;
		}
		if(AC_DR==0){
			flagcar=2;
		}		
	}
		
	if(c<10){
		c++;
	}else{
		flagobs=1;
	}
	
	if (flaglife==0){
		if(l<250){
			l++;
		}else{
			flaglife=1;
		}
	}
	
	/*
	if (flaglife==2){
		if(l<10){
			l++;
		}else{
			flaglife=1;
		}
	}
	
	if(t<100){
		t++;
	}else{
		flagtime=1;
	}
	*/
	
	if(posyobs==5){
		if((poscar>posxobs) && ((poscar+3) < (posxobs + easyobs))){
			LED=0;
			BUZ=0;
		}else{
			flagdie=1;
		}
	}
	
	TF0 = 0;            /* Pone a 0 el flag de interrupción */
}

void intro(){
	int i;
	initlcd();

	pixelxy(0,0);
	for(i=0;i<504;i++)
		wrdata(sega[i]);
		
	while(1){
		if(BUT_AC==0){
			break;
		}
	}
	
	pixelxy(0,0);
	for(i=0;i<504;i++)
		wrdata(logo[i]);
		
	cursorxy(6,1);
	putstr("Buttons Accels");
		
	pixelxy(0,2);
	for(i=0;i<240;i++)
		wrdata(marizq[i]);
		
	while(1){
		if (sel==0){
			if(BUT_DR==0){
				sel=1;
				pixelxy(0,2);
				for(i=0;i<240;i++)
					wrdata(marder[i]);
			}
		}else{
			if(BUT_ES==0){
				sel=0;
				pixelxy(0,2);
				for(i=0;i<240;i++)
					wrdata(marizq[i]);
			}
		}		
		if(BUT_AC==0){
			break;
		}
	}
}

void initgame(){
	int i;
	pixelxy(0,0);
	for(i=0;i<504;i++)
		wrdata(0x00);
	
	pixelxy(40,5);
	for(i=0;i<4;i++)
		wrdata(0x0F);
	
	cursorxy(1,1);
	putstr("00:00");	
	cursorxy(1,12);
	putstr("1");
	pixelxy(75,0);
	for (i=0;i<8;i++){
		wrdata(heart[i]);
	}
	pixelxy(0,1);
	for (i=0;i<84;i++)
		wrdata(0x01);	
	
	poscar = 40;
	posxobs = numrandom(42);
	//posxlife = numrandom(75);
	//posylife = 1;
	posyobs = 1;
	easyobs = 42;

}

unsigned int numrandom(unsigned int max){
	unsigned int num;
	num = rand() % max;
	return num;
}	

void movobs(){
	int rightobs;
	if (posyobs==1){
		pixelxy(aposxobs,5);
		wrdata(0x00);
		
		rightobs = aposxobs + easyobs;
		pixelxy(rightobs,5);
		wrdata(0x00);	
		easyobs = 42 - (d % 35);
	}
	if (posyobs<6){		
		pixelxy(posxobs,posyobs);
		wrdata(0xFF);
		
		rightobs = posxobs + easyobs;
		pixelxy(rightobs,posyobs);
		wrdata(0xFF);
		
		//Limpieza anterior
		if (posyobs==2){
			pixelxy(posxobs,1);
			wrdata(0x01);
			pixelxy(rightobs,1);
			wrdata(0x01);
		}
		if (posyobs>2){
			pixelxy(posxobs,posyobs-1);
			wrdata(0x00);
			pixelxy(rightobs,posyobs-1);
			wrdata(0x00);
		}	
		posyobs++;		
	}else{
		posyobs = 1;
		aposxobs = posxobs;
		posxobs = numrandom(42);
	}
}

void movlife(){
	int i;
	if (posylife<6){
		pixelxy(posxlife,posylife);
		for (i=0;i<8;i++)
			wrdata(heart[i]);	
		
		if(posylife>1){
			pixelxy(posxlife,posylife-1);
			for (i=0;i<8;i++)
				wrdata(0x00);
		}	
	}else{
		pixelxy(posxlife,posylife-1);
		for (i=0;i<8;i++)
			wrdata(0x00);
			
		posylife=1;
		posxlife = numrandom(75);
		flaglife=0;
		l=0;	
	}
}

void changecar(){
	int i;
	
	if ((poscar<81) && (poscar>=0)){ 
		pixelxy(poscar-1,5);
		wrdata(0x00);
	
		pixelxy(poscar+5,5);
		wrdata(0x00);
	
		/*pixelxy(0,5);
		for(i=0;i<84;i++)
			wrdata(0x00);*/
			
		pixelxy(poscar,5);
		for(i=0;i<4;i++)
			wrdata(0x0F);
	}
}

void changetime(){
	if(segs<60){
		cursorxy(1,1);
		putstr("50");
	}else{
		mins++;
		cursorxy(1,1);
		putstr("10:20");
	}
}

void gameover(){
	int i;
	pixelxy(0,1);
	for(i=0;i<420;i++)
		wrdata(0x00);
		
	cursorxy(3,3);
	putstr("GAME OVER");
	
	cursorxy(6,2);
	putstr("Press Reset");
	
	BUZ = 1;
	while(1){
	}
}

void main(){
	LED=0;
	
	intro();	
	initgame();	
	
	inittimer();
	
	LED=1;

	while(1){
		if(flagcar==1){
			flagcar=0;
			poscar--;
			changecar();
		}
		if(flagcar==2){
			flagcar=0;
			poscar++;
			changecar();
		}
		
		if(flagobs==1){
			flagobs=0;
			movobs();
			d++;
			c= 0 + (d/100);
		}
		
		/*if(flaglife==1){
			movlife();
			flaglife=2;
			l=0;
		}*/
		
		if(flagtime==1){
			flagtime=0;
			segs++;
			changetime();
		}
		
		if(flagdie==1){
			BUZ = 0;
			gameover();
		}
		LED = 1;
		BUZ = 1;
	}
}
