/*****************************************************

        Plug n Play Library for Nokia 3310 LCD

        Author:  Ajay Bhargav
		Email :  contact@rickeyworld.info
		WWW   :  www.8051projects.net

		File  :  Nokia3310.C
		Info  :  Test Program to check working of
		         Library

*****************************************************/

#include "main.h"


/* Some Custom Graphics data
   Run it and see it :)      */
   
unsigned int poscar;
int c=0; 
unsigned int posxobs,aposxobs,posyobs,easyobs;
   
unsigned char code sega[504] = {
	0xFF,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
	0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
	0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
	0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
	0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
	0x01,0x01,0x01,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x80,0x80,0x80,0x80,0x80,0x80,0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x80,0x80,
	0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x80,0x80,0x80,0x80,0x80,0x00,0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x80,
	0x80,0x80,0x80,0x80,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x1E,0x31,0x20,0x40,0x40,0x40,0x40,0x81,0x83,0x0F,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0xFF,0x40,0x40,0x40,0x40,0xF0,0x00,0x00,0x00,0x07,0x00,0x00,
	0x00,0x00,0xF8,0x06,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x07,0x00,0x00,
	0x00,0x00,0x00,0x00,0x80,0x70,0x0E,0x01,0x01,0x0E,0x70,0x80,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x7C,0x30,0x20,0x40,0x40,0x40,0x40,0x40,0x20,0x30,
	0x0F,0x00,0x00,0x00,0x00,0x00,0x40,0x40,0x7F,0x40,0x40,0x40,0x40,0x41,0x40,0x40,
	0x40,0x40,0x7C,0x00,0x00,0x00,0x07,0x18,0x20,0x20,0x40,0x40,0x41,0x41,0x41,0x41,
	0x21,0x3F,0x01,0x01,0x40,0x40,0x70,0x4C,0x43,0x01,0x01,0x01,0x01,0x01,0x01,0x43,
	0x4C,0x70,0x40,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,
	0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0xFF,0xFF,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,
	0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,
	0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,
	0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,
	0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,
	0x80,0x80,0x80,0x80,0x80,0x80,0x80,0xFF
};

unsigned char code presents[54] = {
	0x82,0xFE,
	0xA2,0x22,0x1C,0x00,0x00,0x88,0xF8,0x90,0x88,0x08,0x00,0x00,0x70,0xA8,0xA8,0xA8,
	0xB0,0x00,0x00,0x90,0xA8,0xA8,0xA8,0x48,0x00,0x00,0x70,0xA8,0xA8,0xA8,0xB0,0x00,
	0x88,0xF8,0x90,0x08,0x88,0xF0,0x80,0x08,0x7C,0x88,0x88,0x88,0x40,0x00,0x00,0x90,
	0xA8,0xA8,0xA8,0x48
};

void inittimer(){
    TMOD = ((TMOD & 0x0F) | 0x10);
    TF1 = 0; //Interrupcion no atendida.
    ET1 = 1; //Timer habilitado.
    TH1 = 0x0F; //Timer inicializado.
    TL1 = 0x00;
    TR1 = 1; //Si TR1 = 0 no incremente.
   }

void intro(){
	int i;
	initlcd();
	//Print string to LCD
	//putstr("Welcome to Rickey");

	pixelxy(0,0);
	for(i=0;i<504;i++)
		wrdata(sega[i]);
		
	pixelxy(14,4);
	for(i=0;i<54;i++)
		wrdata(presents[i]);
}

void initgame(){
	int i;
	pixelxy(0,0);
	for(i=0;i<504;i++)
		wrdata(0x00);
	
	pixelxy(40,5);
	for(i=0;i<4;i++)
		wrdata(0x0F);
	
	poscar = 40;
	posxobs = numrandom();
	posyobs = 0;
	easyobs = 42;
}

unsigned int numrandom(){
	unsigned int num;
	num = rand() % 6;
	return num;
}	

void changeled(){
	if (LED==0){
		LED=1;
	}else{
		LED=0;
	}			
}

void movobs(){
	int rightobs;	
	if (posyobs<6){		
		pixelxy(posxobs,posyobs);
		wrdata(0xFF);
		
		rightobs = posxobs + easyobs;
		pixelxy(rightobs,posyobs);
		wrdata(0xFF);
		
		//Limpieza anterior
		if (posyobs>0){
			pixelxy(posxobs,posyobs-1);
			wrdata(0x00);
			pixelxy(rightobs,posyobs-1);
			wrdata(0x00);
		}else{
			pixelxy(aposxobs,5);
			wrdata(0x00);
			
			rightobs = aposxobs + easyobs;
			pixelxy(rightobs,5);
			wrdata(0x00);
		}		
		posyobs++;		
	}else{
		posyobs = 0;
		aposxobs = posxobs;
		posxobs = numrandom();
	}
}

void changecar(){
	int i;
	//unsigned int posexa,posexp;
	
	if ((poscar<81) && (poscar>=0)){ 
		/*posexa = poscar - 1;
		pixelxy(posexa,5);
		wrdata(0x00);
	
		posexp = poscar + 5;
		pixelxy(posexp,5);
		wrdata(0x00);*/
	
		pixelxy(0,5);
		for(i=0;i<84;i++)
			wrdata(0x00);
			
		pixelxy(poscar,5);
		for(i=0;i<4;i++)
			wrdata(0x0F);
	}
}

void main(){
	int s;
	inittimer();
	
	intro();	
	initgame();	
	
	for (s=0;s<9;s++){
		movobs();
	}

	while(1){
		if(AC_DR==0)
			LED = 0;
		else
			LED = 1;

		if(AC_ES==0)
			BUZ = 0;
		else
			BUZ = 1;

		if(BUT_ES==0){
			poscar--;
			changecar();
		}
		
		if(BUT_DR==0){
			poscar++;
			changecar();
		}
		
		if(BUT_AC==0){
			movobs();
		}
		if(TF1==1){
			TR1=0;
			ET1=0;
			movobs;
			inittimer();			
		}
	}
}
