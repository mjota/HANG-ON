/*****************************************************

        Plug n Play Library for Nokia 3310 LCD

        Author:  Ajay Bhargav
		Email :  contact@rickeyworld.info
		WWW   :  www.8051projects.net

		File  :  Nokia3310.C
		Info  :  Test Program to check working of
		         Library

*****************************************************/

#include "main.h"


/* Some Custom Graphics data
   Run it and see it :)      */
   
unsigned int poscar;
int c,t=0; 
unsigned int posxobs,aposxobs,posyobs,easyobs;
unsigned int flagobs, flagcarL, flagcarR, flagtime, flagdie = 0;
unsigned int segs,mins = 0;
   
unsigned char code sega[504] = {
	0xFF,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
	0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
	0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
	0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
	0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
	0x01,0x01,0x01,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x80,0x80,0x80,0x80,0x80,0x80,0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x80,0x80,
	0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x80,0x80,0x80,0x80,0x80,0x00,0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x80,
	0x80,0x80,0x80,0x80,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x1E,0x31,0x20,0x40,0x40,0x40,0x40,0x81,0x83,0x0F,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0xFF,0x40,0x40,0x40,0x40,0xF0,0x00,0x00,0x00,0x07,0x00,0x00,
	0x00,0x00,0xF8,0x06,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x07,0x00,0x00,
	0x00,0x00,0x00,0x00,0x80,0x70,0x0E,0x01,0x01,0x0E,0x70,0x80,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x7C,0x30,0x20,0x40,0x40,0x40,0x40,0x40,0x20,0x30,
	0x0F,0x00,0x00,0x00,0x00,0x00,0x40,0x40,0x7F,0x40,0x40,0x40,0x40,0x41,0x40,0x40,
	0x40,0x40,0x7C,0x00,0x00,0x00,0x07,0x18,0x20,0x20,0x40,0x40,0x41,0x41,0x41,0x41,
	0x21,0x3F,0x01,0x01,0x40,0x40,0x70,0x4C,0x43,0x01,0x01,0x01,0x01,0x01,0x01,0x43,
	0x4C,0x70,0x40,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,
	0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0xFF,0xFF,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,
	0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,
	0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,
	0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,
	0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,
	0x80,0x80,0x80,0x80,0x80,0x80,0x80,0xFF
};

unsigned char code presents[54] = {
	0x82,0xFE,
	0xA2,0x22,0x1C,0x00,0x00,0x88,0xF8,0x90,0x88,0x08,0x00,0x00,0x70,0xA8,0xA8,0xA8,
	0xB0,0x00,0x00,0x90,0xA8,0xA8,0xA8,0x48,0x00,0x00,0x70,0xA8,0xA8,0xA8,0xB0,0x00,
	0x88,0xF8,0x90,0x08,0x88,0xF0,0x80,0x08,0x7C,0x88,0x88,0x88,0x40,0x00,0x00,0x90,
	0xA8,0xA8,0xA8,0x48
};

void inittimer(){
	TMOD &= 0xF0;		/*Timer 0 en modo 2: Contador autorecargable */
	TMOD |= 0x09;		/* GATE0=1; C/T0#=0; T0M1=1; T0M0=0; */
	
	TH0 = 0x00;	        /* Valor inicial de autorecarga */
	TL0 = 0x00;			// Valor inicial del contador
	ET0=1;				/* Configura interrupción de timer 0 */
	EA=1;               /* Habilita interrupciones */
	TR0=1;	
}
   
void it_timer0(void) interrupt 1{
	
	if(BUT_ES==0){
		flagcarL=1;
	}
	if(BUT_DR==0){
		flagcarR=1;
	}
		
	if(c<10){
		c++;
	}else{
		flagobs=1;
	}
	
	if(t<100){
		t++;
	}else{
		flagtime=1;
	}
	
	if(posyobs==5){
		if((poscar>posxobs) && ((poscar+3) < (posxobs + easyobs))){
			LED=0;
		}else{
			flagdie=1;
		}
	}
	
	TF0 = 0;            /* Pone a 0 el flag de interrupción */
}

void intro(){
	int i;
	initlcd();

	pixelxy(0,0);
	for(i=0;i<504;i++)
		wrdata(sega[i]);
		
	pixelxy(14,4);
	for(i=0;i<54;i++)
		wrdata(presents[i]);
}

void initgame(){
	int i;
	pixelxy(0,0);
	for(i=0;i<504;i++)
		wrdata(0x00);
	
	pixelxy(40,5);
	for(i=0;i<4;i++)
		wrdata(0x0F);
	
	cursorxy(1,1);
	putstr("00:00   1 LIFE");
	
	poscar = 40;
	posxobs = numrandom();
	posyobs = 1;
	easyobs = 42;

}

unsigned int numrandom(){
	unsigned int num;
	num = rand() % 42;
	return num;
}	

void movobs(){
	int rightobs;	
	if (posyobs<6){		
		pixelxy(posxobs,posyobs);
		wrdata(0xFF);
		
		rightobs = posxobs + easyobs;
		pixelxy(rightobs,posyobs);
		wrdata(0xFF);
		
		//Limpieza anterior
		if (posyobs>1){
			pixelxy(posxobs,posyobs-1);
			wrdata(0x00);
			pixelxy(rightobs,posyobs-1);
			wrdata(0x00);
		}else{
			pixelxy(aposxobs,5);
			wrdata(0x00);
			
			rightobs = aposxobs + easyobs;
			pixelxy(rightobs,5);
			wrdata(0x00);
		}		
		posyobs++;		
	}else{
		posyobs = 1;
		aposxobs = posxobs;
		posxobs = numrandom();
	}
}

void changecar(){
	int i;
	
	if ((poscar<81) && (poscar>=0)){ 
		/*
		pixelxy(poscar-1,5);
		wrdata(0x00);
	
		pixelxy(poscar+5,5);
		wrdata(0x00);*/
	
		pixelxy(0,5);
		for(i=0;i<84;i++)
			wrdata(0x00);
			
		pixelxy(poscar,5);
		for(i=0;i<4;i++)
			wrdata(0x0F);
	}
}

void changetime(){
	if(segs<60){
		cursorxy(1,4);
		putstr("50");
	}else{
		mins++;
		cursorxy(1,1);
		putstr("10:20");
	}
}

void main(){
	LED=0;
	
	intro();	
	initgame();	
	
	inittimer();
	
	LED=1;

	while(1){
		if(flagcarL==1){
			flagcarL=0;
			poscar--;
			changecar();
		}
		if(flagcarR==1){
			flagcarR=0;
			poscar++;
			changecar();
		}
		
		if(flagobs==1){
			flagobs=0;
			movobs();
			c=0;
		}
		
		if(flagtime==1){
			flagtime=0;
			segs++;
			changetime();
		}
		
		if(flagdie==1){
			flagdie=0;
			BUZ = 0;
		}
		
		if(AC_DR==0)
			LED = 0;
		else
			LED = 1;

		if(AC_ES==0)
			BUZ = 0;
		else
			BUZ = 1;
		
		if(BUT_AC==0){
			movobs();
		}		
	}
}
